### 事务

#### 1.什么是事务？

**事务就是逻辑上的一组操作，要么都执行，要么都不执行**

#### 2.事务的基本特性是什么?

1. **原子性（Atomicity）**:

    事务是**最小的执行单位，不予许分割**，事务的原子性保证动作么全部完成，要么完全不起作用

1. **一致性（Consistency）**:

    执行事务前后，数据保持一致，**多个事务对同一个数据读取结果是相同的**

1. **隔离性（Isolation）**：

    并发访问数据库时，一个用户的事务不被其他事务所干扰，**各并发事务之间数据库是独立的**

1. **持久性（Durability）**

    一个事务被提交之后，它**对数据库中数据的改变是持久的**，即使数据库发生故障也不应该对其有任何影响

#### 3.如何保证事务的ACID?

使用undo log 来实现事务的原子性，使用代码逻辑来保证事务的一致性，使用MVCC来保证事务的隔离性，使用Redo log来实现事务的持久性。

- Undo log是什么？

    Undo Log记录的是逻辑日志，用来回滚事务时，恢复到修改前的数据。

    ![image.png](https://hruoxuan.oss-cn-shenzhen.aliyuncs.com/image.png)

- Redo log 是什么？

    Redo Log记录的是物理日志，也就是磁盘数据的修改。 用来保证服务崩溃后，仍能把事务中变更的数据持久化到磁盘上。

    ![image.png](https://hruoxuan.oss-cn-shenzhen.aliyuncs.com/image%201.png)

- MVCC是什么？

    **多版本并发控制**(Multiversion concurrency control， **MCC** 或 **MVCC**)，是数据库管理系统常用的一种并发控制，也用于程序设计语言实现事务内存。

    MVCC意图解决读写锁造成的多个、长时间的读操作饿死写操作问题。每个事务读到的数据项都是一个历史快照，并依赖于实现的隔离级别。写操作不覆盖已有数据项，而是创建一个新的版本，直至所在操作提交时才变为可见。快照隔离使得事务看到它启动时的数据状态。

    其基本的算法为：

    MVCC使用时间戳 (**TS**), 或“自动增量的事务ID”实现“事务一致性”。MVCC可以确保每个事务(**T**)通常不必“读等待”数据库对象(**P**)。这通过对象有多个版本，每个版本有*创建时间戳* 与*废止时间戳* (**WTS**)做到的。

    事务**Ti**读取对象(**P**)时，只有比事务**Ti**的时间戳早，但是时间上最接近事务**Ti**的对象版本可见，且该版本应该没有被废止。

    事务**Ti**写入对象**P**时，如果还有事务**Tk**要写入同一对象，则(**Ti**)必须早于(**Tk**)，即 (**Ti**) < (**Tk**)，才能成功。

    MVCC可以无锁实现。

#### 4.在并发中事务会遇上那些问题？

- **脏读（Dirty Read）：** 一个事务读取了另一个事务未提交的数据。如果另一个事务最终回滚，读取的数据就是无效的。

- **不可重复读（Non-Repeatable Read）：** 一个事务在两次读取之间，另一个事务修改了数据，导致第一个事务两次读取的数据不一致。

- **幻读（Phantom Read）：** 一个事务在两次查询之间，另一个事务插入或删除了数据，导致第一个事务两次查询的结果不一致。

- **丢失更新（Lost Update）：** 两个事务同时读取相同的数据，并尝试更新它。由于并发执行，其中一个事务的更新可能会覆盖另一个事务的更新，导致数据丢失。

#### 5.隔离级别有哪些？

- **READ UNCOMMITTED（未提交读）：** 允许一个事务读取另一个事务尚未提交的数据变更。这是最低级别的隔离，可能导致脏读、不可重复读和幻读的问题。
- **READ COMMITTED（提交读）：** 允许一个事务只能读取已经提交的其他事务的数据变更。这是MySQL的默认隔离级别，可以防止脏读，但仍可能出现不可重复读和幻读。
- **REPEATABLE READ（可重复读）：** 保证在同一事务中多次读取相同数据时，将始终看到相同的数据。可防止脏读和不可重复读，但仍可能有幻读的问题。
- **SERIALIZABLE（串行化）：** 提供最高的隔离级别，确保事务之间完全隔离，不会出现脏读、不可重复读和幻读。它通过强制事务串行执行来实现。



